name: Export Intune Policy from DEV

on:
  workflow_dispatch:

jobs:
  export-policy:
    runs-on: windows-latest

    env:
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      TENANT_ID: ${{ secrets.TENANT_ID }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Export Intune policy from DEV
      shell: pwsh
      run: |
        $tenantId     = $env:TENANT_ID
        $clientId     = $env:CLIENT_ID
        $clientSecret = $env:CLIENT_SECRET

        $authUri = "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token"
        $authBody = @{
          client_id     = $clientId
          scope         = "https://graph.microsoft.com/.default"
          client_secret = $clientSecret
          grant_type    = "client_credentials"
        }

        Write-Host "Authenticating to Azure AD..."
        $authResponse = Invoke-RestMethod -Method POST -Uri $authUri -Body $authBody -ContentType "application/x-www-form-urlencoded"
        $accessToken = $authResponse.access_token

        if (-not $accessToken) {
          Write-Error "Access token is null. Check authentication inputs."
          exit 1
        }

        $headers = @{ Authorization = "Bearer $accessToken" }
        $uri = "https://graph.microsoft.com/beta/deviceManagement/deviceConfigurations"

        Write-Host "Fetching configuration profiles..."
        $response = Invoke-RestMethod -Uri $uri -Headers $headers -Method GET

        Write-Host "Saving policy to dev-policy.json..."
        $response.value | ConvertTo-Json -Depth 10 | Out-File "dev-policy.json"

    - name: Push dev-policy.json to repo using PAT
      shell: bash
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git checkout main
    
        # Set remote with PAT
        git remote set-url origin https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}
    
        # Commit and push if there are changes
        if ! git diff --quiet; then
          git add dev-policy.json
          git commit -m "Exported policy from DEV"
          git push origin main
        else
          echo "No changes to commit."
        fi
